<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Simulator Capturing Earth</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #0f0; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        
        #login-screen {
            position: absolute; width: 100%; height: 100%;
            background: radial-gradient(circle, #1a1a1a 0%, #000000 100%);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            pointer-events: auto; transition: opacity 0.5s; z-index: 20;
        }
        
        h1 { text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 0 15px #0f0; text-align: center; margin-bottom: 20px; font-size: 24px;}
        
        input, select, button {
            background: #000; border: 1px solid #0f0; color: #0f0; padding: 10px; font-size: 16px; margin: 5px; outline: none;
        }
        
        button { cursor: pointer; font-weight: bold; text-transform: uppercase; transition: 0.3s; }
        button:hover { background: #0f0; color: #000; box-shadow: 0 0 10px #0f0; }
        button.active { background: #0f0; color: #000; box-shadow: 0 0 15px #0f0; }
        button.danger { border-color: #f00; color: #f00; margin-top: 10px; }
        button.danger:hover { background: #f00; color: #fff; }

        #device-select { display: flex; gap: 10px; margin-bottom: 20px; }
        .dev-btn { width: 120px; padding: 15px; }

        #controls {
            position: absolute; top: 10px; left: 10px; bottom: 10px; width: 350px;
            background: rgba(0, 15, 0, 0.9); border: 1px solid #0f0; padding: 15px;
            overflow-y: auto; pointer-events: auto; display: none;
        }

        body.mobile-mode #controls {
            top: 0; left: 0; width: 100%; height: 100%; box-sizing: border-box; bottom: 0; right: 0;
            z-index: 50; padding-bottom: 50px;
        }

        #mobile-menu-btn {
            position: absolute; top: 10px; left: 10px; pointer-events: auto; z-index: 15;
            background: rgba(0,0,0,0.8); border: 2px solid #0f0; padding: 10px 20px;
            display: none; font-size: 20px;
        }

        #mobile-close-btn { display: none; width: 100%; padding: 15px; background: #003300; border: 1px solid #0f0; margin-bottom: 20px; }

        .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 13px; }
        input[type="color"] { border: none; width: 30px; height: 30px; padding: 0; }
        input[type="range"] { width: 100%; }
        .slider-group { display: flex; gap: 5px; align-items: center; }
        .percent-input { width: 60px !important; text-align: center; }
        
        #rec-status { color: red; font-weight: bold; text-align: center; display: none; animation: blink 1s infinite; margin-top:15px; border: 1px solid red; padding: 5px;}
        @keyframes blink { 50% { opacity: 0; } }
        #download-area { margin-top: 10px; display: none; }
        #download-area a { display: block; background: #d00; color: white; padding: 10px; text-align: center; text-decoration: none; }
        
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #0f0; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body>

    <div id="ui-layer">
        <div id="login-screen">
            <h1 id="title-text">Simulator Capturing Earth</h1>
            
            <select id="lang-select" onchange="changeLanguage()" style="margin-bottom: 10px;">
                <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                <option value="en">English</option>
                <option value="cn">‰∏≠Êñá</option>
                <option value="jp">Êó•Êú¨Ë™û</option>
            </select>

            <div id="device-select">
                <button class="dev-btn active" id="btn-pc" onclick="selectDevice('pc')">PC</button>
                <button class="dev-btn" id="btn-mob" onclick="selectDevice('mobile')">PHONE</button>
            </div>

            <input type="text" id="start-invader-name" placeholder="..." style="width: 250px; text-align: center; margin-bottom: 20px;">
            <button id="btn-enter" onclick="enterSim()" style="width: 200px; padding: 15px;">START</button>
        </div>

        <button id="mobile-menu-btn" onclick="toggleMobileMenu()">‚öô SETTINGS</button>

        <div id="controls">
            <button id="mobile-close-btn" onclick="toggleMobileMenu()">OK / CLOSE MENU</button>
            
            <h3 id="h-settings">SETTINGS</h3>
            
            <div class="row">
                <span id="lbl-planet">Planet Name:</span>
                <input type="text" id="planet-name" value="Earth" oninput="updateHUDText()">
            </div>
            <div class="row">
                <span id="lbl-invader">Invader Name:</span>
                <input type="text" id="invader-name" value="" oninput="updateHUDText()">
            </div>
            <div class="row">
                <span id="lbl-pop">Population:</span>
                <input type="number" id="base-pop" value="8000000000" oninput="updateHUDText()">
            </div>
            <div class="row">
                <span id="lbl-mode">Pop Mode:</span>
                <select id="pop-mode" onchange="updateHUDText()">
                    <option value="static" id="opt-static">Static</option>
                    <option value="death" id="opt-death">Genocide</option>
                </select>
            </div>

            <h3 id="h-colors">COLORS</h3>
            <div class="row"><span id="lbl-c-water">Water:</span><input type="color" id="c-water" value="#0022ff" onchange="updateColors()"></div>
            <div class="row"><span id="lbl-c-land">Land:</span><input type="color" id="c-land" value="#228822" onchange="updateColors()"></div>
            <div class="row"><span id="lbl-c-enemy">Enemy:</span><input type="color" id="c-enemy" value="#ff0000" onchange="updateColors()"></div>

            <h3 id="h-stats">HUD STATS</h3>
            <div class="row"><input type="checkbox" id="show-hud" checked onchange="toggleHudVisibility()"> <span id="chk-hud">Show HUD</span></div>
            
            <h3 id="h-manual">MANUAL CONTROL</h3>
            <div class="slider-group">
                <input type="range" id="manual-slider" min="0" max="100" value="0" step="0.1">
                <input type="number" id="manual-input" class="percent-input" value="0" min="0" max="100" step="0.1">
                <span>%</span>
            </div>

            <h3 id="h-video">VIDEO GENERATOR</h3>
            <div class="row">
                <span id="lbl-time">Time (sec):</span>
                <input type="number" id="sim-time" value="15" min="1" style="width:50px;">
            </div>
            <div class="row">
                <span id="lbl-scen">Scenario:</span>
                <select id="sim-type">
                    <option value="blitz" id="opt-blitz">Blitz Invasion</option>
                    <option value="war" id="opt-war">Heavy War</option>
                    <option value="liberation" id="opt-lib">Liberation</option>
                    <option value="heavy_lib" id="opt-hlib">Heavy Liberation</option>
                </select>
            </div>
            <div class="row">
                <span id="lbl-res">Result:</span>
                <select id="sim-result">
                    <option value="win_invader" id="opt-win-inv">Invaders Win</option>
                    <option value="win_defender" id="opt-win-def">Defenders Win</option>
                </select>
            </div>

            <button id="btn-rec" onclick="startRecordingSim()">REC & START</button>
            <div id="rec-status">RECORDING...</div>
            <div id="download-area"></div>

            <button id="btn-back" class="danger" onclick="backToMenu()">BACK TO MENU</button>
        </div>
    </div>

    <div id="canvas-container"></div>

    <script>
        const LANG = {
            ru: {
                title: "–°–ò–ú–£–õ–Ø–¢–û–† –ó–ê–•–í–ê–¢–ê –ó–ï–ú–õ–ò",
                placeholder: "–ò–º—è –ó–∞—Ö–≤–∞—Ç—á–∏–∫–æ–≤",
                btn_enter: "–ó–ê–ü–£–°–¢–ò–¢–¨",
                h_settings: "–ù–ê–°–¢–†–û–ô–ö–ò –ú–ò–†–ê",
                lbl_planet: "–ò–º—è –ü–ª–∞–Ω–µ—Ç—ã:",
                lbl_invader: "–ò–º—è –í—Ä–∞–≥–∞:",
                lbl_pop: "–ù–∞—Å–µ–ª–µ–Ω–∏–µ:",
                lbl_mode: "–†–µ–∂–∏–º:",
                opt_static: "–ë–µ—Å—Å–º–µ—Ä—Ç–Ω—ã–µ",
                opt_death: "–ì–µ–Ω–æ—Ü–∏–¥",
                h_colors: "–¶–í–ï–¢–û–í–ê–Ø –°–•–ï–ú–ê",
                lbl_c_water: "–í–æ–¥–∞:",
                lbl_c_land: "–°—É—à–∞:",
                lbl_c_enemy: "–í—Ä–∞–≥:",
                h_stats: "–°–¢–ê–¢–ò–°–¢–ò–ö–ê",
                chk_hud: "–ü–æ–∫–∞–∑–∞—Ç—å –¢–∞–±–ª–æ",
                h_manual: "–†–£–ß–ù–û–ô –ö–û–ù–¢–†–û–õ–¨",
                h_video: "–ì–ï–ù–ï–†–ê–¶–ò–Ø –í–ò–î–ï–û",
                lbl_time: "–í—Ä–µ–º—è (—Å–µ–∫):",
                lbl_scen: "–°—Ü–µ–Ω–∞—Ä–∏–π:",
                opt_blitz: "–ë—ã—Å—Ç—Ä—ã–π –ó–∞—Ö–≤–∞—Ç",
                opt_war: "–¢—è–∂–µ–ª–∞—è –í–æ–π–Ω–∞",
                opt_lib: "–û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ",
                opt_hlib: "–¢—è–∂–µ–ª–æ–µ –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ",
                lbl_res: "–ò—Ç–æ–≥:",
                opt_win_inv: "–ü–æ–±–µ–¥–∞ –í—Ä–∞–≥–∞",
                opt_win_def: "–ü–æ–±–µ–¥–∞ –ó–∞—â–∏—Ç—ã",
                btn_rec: "üî¥ –ó–ê–ü–ò–°–¨ –ò –°–¢–ê–†–¢",
                btn_back: "‚¨Ö –ù–ê–ó–ê–î –í –ú–ï–ù–Æ",
                status_rec: "–ò–î–ï–¢ –ó–ê–ü–ò–°–¨...",
                status_proc: "–û–ë–†–ê–ë–û–¢–ö–ê...",
                dl_btn: "‚¨á –°–ö–ê–ß–ê–¢–¨ –í–ò–î–ï–û",
                mob_set: "‚öô –ù–ê–°–¢–†–û–ô–ö–ò",
                mob_close: "OK / –ó–ê–ö–†–´–¢–¨ –ú–ï–ù–Æ"
            },
            en: {
                title: "SIMULATOR CAPTURING EARTH",
                placeholder: "Invader Name",
                btn_enter: "LAUNCH",
                h_settings: "WORLD SETTINGS",
                lbl_planet: "Planet Name:",
                lbl_invader: "Invader Name:",
                lbl_pop: "Population:",
                lbl_mode: "Mode:",
                opt_static: "Immortal",
                opt_death: "Genocide",
                h_colors: "COLOR SCHEME",
                lbl_c_water: "Water:",
                lbl_c_land: "Land:",
                lbl_c_enemy: "Enemy:",
                h_stats: "STATISTICS",
                chk_hud: "Show HUD",
                h_manual: "MANUAL CONTROL",
                h_video: "VIDEO GENERATION",
                lbl_time: "Time (sec):",
                lbl_scen: "Scenario:",
                opt_blitz: "Blitz Invasion",
                opt_war: "Heavy War",
                opt_lib: "Liberation",
                opt_hlib: "Heavy Liberation",
                lbl_res: "Result:",
                opt_win_inv: "Invaders Win",
                opt_win_def: "Defenders Win",
                btn_rec: "üî¥ REC & START",
                btn_back: "‚¨Ö BACK TO MENU",
                status_rec: "RECORDING...",
                status_proc: "PROCESSING...",
                dl_btn: "‚¨á DOWNLOAD VIDEO",
                mob_set: "‚öô SETTINGS",
                mob_close: "OK / CLOSE MENU"
            },
            cn: {
                title: "Âú∞ÁêÉÂç†È¢ÜÊ®°ÊãüÂô®",
                placeholder: "‰æµÁï•ËÄÖÂêçÁß∞",
                btn_enter: "ÂèëÂ∞Ñ",
                h_settings: "‰∏ñÁïåËÆæÁΩÆ",
                lbl_planet: "ÊòüÁêÉÂêçÁß∞:",
                lbl_invader: "Êïå‰∫∫ÂêçÁß∞:",
                lbl_pop: "‰∫∫Âè£:",
                lbl_mode: "Ê®°Âºè:",
                opt_static: "‰∏çÊúΩ",
                opt_death: "ÁßçÊóèÁÅ≠Áªù",
                h_colors: "ÈÖçËâ≤ÊñπÊ°à",
                lbl_c_water: "Ê∞¥:",
                lbl_c_land: "ÈôÜÂú∞:",
                lbl_c_enemy: "Êïå‰∫∫:",
                h_stats: "ÁªüËÆ°",
                chk_hud: "ÊòæÁ§∫ÁïåÈù¢",
                h_manual: "ÊâãÂä®ÊéßÂà∂",
                h_video: "ËßÜÈ¢ëÁîüÊàê",
                lbl_time: "Êó∂Èó¥ (Áßí):",
                lbl_scen: "ÂâßÊú¨:",
                opt_blitz: "Âø´ÈÄüÂÖ•‰æµ",
                opt_war: "Ëâ∞ÈöæÊàò‰∫â",
                opt_lib: "Ëß£Êîæ",
                opt_hlib: "Ëâ∞ÈöæËß£Êîæ",
                lbl_res: "ÁªìÊûú:",
                opt_win_inv: "‰æµÁï•ËÄÖËÉúÂà©",
                opt_win_def: "Èò≤ÂÆàÊñπËÉúÂà©",
                btn_rec: "üî¥ ÂΩïÂà∂Âπ∂ÂºÄÂßã",
                btn_back: "‚¨Ö ËøîÂõûËèúÂçï",
                status_rec: "ÂΩïÂà∂‰∏≠...",
                status_proc: "Â§ÑÁêÜ‰∏≠...",
                dl_btn: "‚¨á ‰∏ãËΩΩËßÜÈ¢ë",
                mob_set: "‚öô ËÆæÁΩÆ",
                mob_close: "OK / ÂÖ≥Èó≠ËèúÂçï"
            },
            jp: {
                title: "Âú∞ÁêÉÂç†È†ò„Ç∑„Éü„É•„É¨„Éº„Çø„Éº",
                placeholder: "‰æµÁï•ËÄÖ„ÅÆÂêçÂâç",
                btn_enter: "Êâì„Å°‰∏ä„Åí",
                h_settings: "‰∏ñÁïåË®≠ÂÆö",
                lbl_planet: "ÊÉëÊòüÂêç:",
                lbl_invader: "Êïµ„ÅÆÂêçÂâç:",
                lbl_pop: "‰∫∫Âè£:",
                lbl_mode: "„É¢„Éº„Éâ:",
                opt_static: "‰∏çÊªÖ",
                opt_death: "Â§ßÈáèËôêÊÆ∫",
                h_colors: "ÈÖçËâ≤",
                lbl_c_water: "Ê∞¥:",
                lbl_c_land: "Èô∏:",
                lbl_c_enemy: "Êïµ:",
                h_stats: "Áµ±Ë®à",
                chk_hud: "HUD„ÇíË°®Á§∫",
                h_manual: "ÊâãÂãïÂà∂Âæ°",
                h_video: "„Éì„Éá„Ç™ÁîüÊàê",
                lbl_time: "ÊôÇÈñì (Áßí):",
                lbl_scen: "„Ç∑„Éä„É™„Ç™:",
                opt_blitz: "ÈõªÊíÉ‰æµÁï•",
                opt_war: "ÊøÄÊà¶",
                opt_lib: "Ëß£Êîæ",
                opt_hlib: "ÊøÄ„Åó„ÅÑËß£ÊîæÊà¶",
                lbl_res: "ÁµêÊûú:",
                opt_win_inv: "‰æµÁï•ËÄÖ„ÅÆÂãùÂà©",
                opt_win_def: "Èò≤Ë°õÂÅ¥„ÅÆÂãùÂà©",
                btn_rec: "üî¥ Èå≤ÁîªÈñãÂßã",
                btn_back: "‚¨Ö „É°„Éã„É•„Éº„Å´Êàª„Çã",
                status_rec: "Èå≤Áîª‰∏≠...",
                status_proc: "Âá¶ÁêÜ‰∏≠...",
                dl_btn: "‚¨á „Éì„Éá„Ç™„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ",
                mob_set: "‚öô Ë®≠ÂÆö",
                mob_close: "OK / „É°„Éã„É•„Éº„ÇíÈñâ„Åò„Çã"
            }
        };

        let currentLang = 'ru';
        let deviceMode = 'pc';
        let scene, camera, renderer, globe, stars, controls;
        let hudMesh, hudCanvas, hudCtx, hudTexture;
        let vertexData = [];
        let isSimulating = false;
        let simStart = 0, simDuration = 0;
        let recorder, chunks = [];
        let currentPercent = 0;

        function selectDevice(mode) {
            deviceMode = mode;
            document.getElementById('btn-pc').className = (mode === 'pc') ? 'dev-btn active' : 'dev-btn';
            document.getElementById('btn-mob').className = (mode === 'mobile') ? 'dev-btn active' : 'dev-btn';
            
            // –û–ë–ù–û–í–õ–ï–ù–ò–ï –ü–û–ó–ò–¶–ò–ò HUD
            updateHudPosition();
        }

        function updateHudPosition() {
            if(!hudMesh) return;
            if(deviceMode === 'mobile') {
                // –î–õ–Ø –¢–ï–õ–ï–§–û–ù–ê: –¶–ï–ù–¢–† –í–ù–ò–ó–£
                hudMesh.position.set(0, -6.5, -15);
                hudMesh.scale.set(0.9, 0.9, 1);
            } else {
                // –î–õ–Ø –ü–ö: –°–ü–†–ê–í–ê
                hudMesh.position.set(7.5, 0, -15);
                hudMesh.scale.set(1, 1, 1);
            }
        }

        function toggleMobileMenu() {
            const el = document.getElementById('controls');
            if(el.style.display === 'block') {
                el.style.display = 'none';
            } else {
                el.style.display = 'block';
            }
        }

        function changeLanguage() {
            currentLang = document.getElementById('lang-select').value;
            const t = LANG[currentLang];
            document.getElementById('title-text').innerText = t.title;
            document.getElementById('start-invader-name').placeholder = t.placeholder;
            document.getElementById('btn-enter').innerText = t.btn_enter;
            document.getElementById('h-settings').innerText = t.h_settings;
            document.getElementById('lbl-planet').innerText = t.lbl_planet;
            document.getElementById('lbl-invader').innerText = t.lbl_invader;
            document.getElementById('lbl-pop').innerText = t.lbl_pop;
            document.getElementById('lbl-mode').innerText = t.lbl_mode;
            document.getElementById('opt-static').innerText = t.opt_static;
            document.getElementById('opt-death').innerText = t.opt_death;
            document.getElementById('h-colors').innerText = t.h_colors;
            document.getElementById('lbl-c-water').innerText = t.lbl_c_water;
            document.getElementById('lbl-c-land').innerText = t.lbl_c_land;
            document.getElementById('lbl-c-enemy').innerText = t.lbl_c_enemy;
            document.getElementById('h-stats').innerText = t.h_stats;
            document.getElementById('chk-hud').innerText = t.chk_hud;
            document.getElementById('h-manual').innerText = t.h_manual;
            document.getElementById('h-video').innerText = t.h_video;
            document.getElementById('lbl-time').innerText = t.lbl_time;
            document.getElementById('lbl-scen').innerText = t.lbl_scen;
            document.getElementById('opt-blitz').innerText = t.opt_blitz;
            document.getElementById('opt-war').innerText = t.opt_war;
            document.getElementById('opt-lib').innerText = t.opt_lib;
            document.getElementById('opt-hlib').innerText = t.opt_hlib;
            document.getElementById('lbl-res').innerText = t.lbl_res;
            document.getElementById('opt-win-inv').innerText = t.opt_win_inv;
            document.getElementById('opt-win-def').innerText = t.opt_win_def;
            document.getElementById('btn-rec').innerText = t.btn_rec;
            document.getElementById('btn-back').innerText = t.btn_back;
            document.getElementById('mobile-menu-btn').innerText = t.mob_set;
            document.getElementById('mobile-close-btn').innerText = t.mob_close;
            updateHUDText();
        }

        function init() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.002);
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 24;
            renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('canvas-container').appendChild(renderer.domElement);
            const sun = new THREE.DirectionalLight(0xffffff, 1.2);
            sun.position.set(50, 20, 30);
            scene.add(sun);
            scene.add(new THREE.AmbientLight(0x404040));
            scene.add(new THREE.DirectionalLight(0x0022ff, 0.5));
            createStars();
            createEarth();
            createHUD();
            
            // –í—ã–∑–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏ —Å—Ä–∞–∑—É –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
            updateHudPosition();

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.minDistance = 12;
            controls.maxDistance = 50;
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
            const slider = document.getElementById('manual-slider');
            const numInput = document.getElementById('manual-input');
            slider.addEventListener('input', (e) => {
                if(isSimulating) return;
                const val = parseFloat(e.target.value);
                numInput.value = val;
                setInvasionPercent(val);
            });
            numInput.addEventListener('input', (e) => {
                if(isSimulating) return;
                let val = parseFloat(e.target.value);
                if(isNaN(val)) return;
                if(val < 0) val = 0; if(val > 100) val = 100;
                slider.value = val;
                setInvasionPercent(val);
            });
            changeLanguage();
            animate();
        }

        function createStars() {
            const geo = new THREE.BufferGeometry();
            const pos = [];
            for(let i=0; i<5000; i++) {
                pos.push((Math.random()-0.5)*400, (Math.random()-0.5)*400, (Math.random()-0.5)*400);
            }
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            stars = new THREE.Points(geo, new THREE.PointsMaterial({color:0xaaaaaa, size:0.12}));
            scene.add(stars);
        }

        function createEarth() {
            const geo = new THREE.IcosahedronGeometry(9, 5);
            const count = geo.attributes.position.count;
            geo.setAttribute('color', new THREE.BufferAttribute(new Float32Array(count*3), 3));
            vertexData = [];
            const pos = geo.attributes.position;
            for(let i=0; i<count; i++){
                const x = pos.getX(i), y = pos.getY(i), z = pos.getZ(i);
                const noise = Math.sin(x/3) * Math.cos(y/3) + Math.sin(z/3);
                const isLand = noise > 0.1;
                let resist = (Math.sin(x*2) + Math.cos(y*2) + 2) / 4; 
                resist += (Math.random()-0.5)*0.2;
                vertexData.push({ isLand, resist });
            }
            const mat = new THREE.MeshPhongMaterial({ vertexColors: true, flatShading: true, shininess: 15 });
            globe = new THREE.Mesh(geo, mat);
            scene.add(globe);
            const atmo = new THREE.Mesh(
                new THREE.SphereGeometry(9.4, 32, 32),
                new THREE.MeshBasicMaterial({ color: 0x4488ff, transparent: true, opacity: 0.1, side: THREE.BackSide })
            );
            scene.add(atmo);
            updateColors();
        }

        function createHUD() {
            hudCanvas = document.createElement('canvas');
            hudCanvas.width = 512; hudCanvas.height = 512;
            hudCtx = hudCanvas.getContext('2d');
            hudTexture = new THREE.CanvasTexture(hudCanvas);
            hudTexture.minFilter = THREE.LinearFilter;
            const mat = new THREE.MeshBasicMaterial({ map: hudTexture, transparent: true, depthTest: false, depthWrite: false });
            hudMesh = new THREE.Mesh(new THREE.PlaneGeometry(8, 8), mat);
            
            // –ü–æ–∑–∏—Ü–∏—è –±—É–¥–µ—Ç –∑–∞–¥–∞–Ω–∞ –≤ updateHudPosition
            camera.add(hudMesh);
            scene.add(camera);
            updateHUDText();
        }

        function toggleHudVisibility() {
            if(hudMesh) hudMesh.visible = document.getElementById('show-hud').checked;
        }

        function updateHUDText() {
            if(!hudCtx) return;
            hudCtx.clearRect(0,0, 512, 512);
            hudCtx.fillStyle = "rgba(0, 10, 0, 0.75)";
            hudCtx.strokeStyle = "#0f0";
            hudCtx.lineWidth = 3;
            hudCtx.fillRect(100, 100, 400, 320);
            hudCtx.strokeRect(100, 100, 400, 320);

            const pName = document.getElementById('planet-name').value;
            const iName = document.getElementById('invader-name').value;
            const popMode = document.getElementById('pop-mode').value;
            let popBase = parseInt(document.getElementById('base-pop').value);
            let displayPop = popBase;
            if (popMode === 'death') {
                let alivePercent = (100 - currentPercent) / 100;
                if(alivePercent < 0) alivePercent = 0;
                displayPop = Math.floor(popBase * alivePercent);
            }

            hudCtx.fillStyle = "#0f0";
            hudCtx.font = "bold 24px 'Courier New'";
            hudCtx.textBaseline = "top";
            let lineY = 120;
            const x = 120;
            const t = LANG[currentLang];

            hudCtx.fillStyle = "#fff";
            hudCtx.fillText("STATUS REPORT", x, lineY);
            hudCtx.fillStyle = "#0f0";
            lineY += 50;

            hudCtx.fillText(`${t.lbl_planet} ${pName.toUpperCase()}`, x, lineY);
            lineY += 40;
            hudCtx.fillStyle = "#ff5555";
            hudCtx.fillText(`${t.lbl_invader} ${iName.toUpperCase()}`, x, lineY);
            hudCtx.fillStyle = "#0f0";
            lineY += 40;
            hudCtx.fillText(t.lbl_pop, x, lineY);
            lineY += 25;
            hudCtx.fillStyle = (popMode==='death' && currentPercent > 0) ? "#ffff00" : "#0f0";
            hudCtx.fillText(displayPop.toLocaleString('en-US'), x+20, lineY);
            hudCtx.fillStyle = "#0f0";
            lineY += 40;
            lineY += 10;
            hudCtx.fillStyle = "#ff3333";
            hudCtx.fillText(`${currentPercent.toFixed(1)}%`, x, lineY);
            hudCtx.fillStyle = "#33ccff";
            hudCtx.fillText(`${(100 - currentPercent).toFixed(1)}%`, x+180, lineY);
            hudTexture.needsUpdate = true;
        }

        function setInvasionPercent(pct) {
            currentPercent = pct;
            if(currentPercent < 0) currentPercent = 0;
            if(currentPercent > 100) currentPercent = 100;
            document.getElementById('manual-slider').value = currentPercent;
            document.getElementById('manual-input').value = currentPercent.toFixed(1);
            updateColors();
            updateHUDText();
        }

        function updateColors() {
            if(!globe) return;
            const cLand = new THREE.Color(document.getElementById('c-land').value);
            const cWater = new THREE.Color(document.getElementById('c-water').value);
            const cEnemy = new THREE.Color(document.getElementById('c-enemy').value);
            const cEnemyWater = cEnemy.clone().multiplyScalar(0.5);
            const colors = globe.geometry.attributes.color;
            const normP = currentPercent / 100;
            for(let i=0; i<vertexData.length; i++) {
                const d = vertexData[i];
                let isCaptured = false;
                if(normP >= 1) isCaptured = true;
                else if(normP <= 0) isCaptured = false;
                else if (d.resist < normP) isCaptured = true;
                const col = new THREE.Color();
                if(isCaptured) {
                    if(d.isLand) { col.copy(cEnemy); col.r += (Math.random()-0.5)*0.1; }
                    else { col.copy(cEnemyWater); }
                } else {
                    if(d.isLand) { col.copy(cLand); col.g += (Math.random()-0.5)*0.05; }
                    else { col.copy(cWater); col.b += (Math.random()-0.5)*0.1; }
                }
                colors.setXYZ(i, col.r, col.g, col.b);
            }
            colors.needsUpdate = true;
        }

        function enterSim() {
            const name = document.getElementById('start-invader-name').value;
            if(!name) return;
            document.getElementById('invader-name').value = name;
            updateHUDText();
            document.getElementById('login-screen').style.opacity = 0;
            setTimeout(()=> document.getElementById('login-screen').style.display = 'none', 500);
            
            if(deviceMode === 'mobile') {
                document.body.classList.add('mobile-mode');
                document.getElementById('mobile-menu-btn').style.display = 'block';
                document.getElementById('mobile-close-btn').style.display = 'block';
                document.getElementById('controls').style.display = 'none';
            } else {
                document.body.classList.remove('mobile-mode');
                document.getElementById('mobile-menu-btn').style.display = 'none';
                document.getElementById('mobile-close-btn').style.display = 'none';
                document.getElementById('controls').style.display = 'block';
            }
        }

        function backToMenu() {
            isSimulating = false;
            if(recorder && recorder.state !== 'inactive') recorder.stop();
            document.getElementById('rec-status').style.display = 'none';
            setInvasionPercent(0);
            document.getElementById('controls').style.display = 'none';
            document.getElementById('mobile-menu-btn').style.display = 'none';
            const login = document.getElementById('login-screen');
            login.style.display = 'flex';
            setTimeout(() => login.style.opacity = 1, 10);
        }

        function startRecordingSim() {
            if(isSimulating) return;
            simDuration = parseFloat(document.getElementById('sim-time').value) * 1000;
            const scenario = document.getElementById('sim-type').value;
            const result = document.getElementById('sim-result').value;
            const t = LANG[currentLang];
            if (scenario.includes('lib')) setInvasionPercent(100);
            else setInvasionPercent(0);
            document.getElementById('rec-status').innerText = t.status_rec;
            document.getElementById('rec-status').style.display = 'block';
            document.getElementById('download-area').style.display = 'none';
            const stream = document.querySelector('canvas').captureStream(30);
            recorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
            chunks = [];
            recorder.ondataavailable = e => { if(e.data.size > 0) chunks.push(e.data); };
            recorder.onstop = saveVideo;
            recorder.start();
            isSimulating = true;
            simStart = Date.now();
            if(deviceMode === 'mobile') toggleMobileMenu();
            
            function simLoop() {
                if(!isSimulating) return;
                const now = Date.now();
                const progress = (now - simStart) / simDuration;
                if(progress >= 1) {
                    let endVal = 0;
                    if(scenario.includes('lib')) endVal = (result === 'win_defender') ? 0 : 100;
                    else endVal = (result === 'win_invader') ? 100 : 0;
                    finishSim(endVal);
                    return;
                }
                let p = 0;
                if (scenario === 'blitz') {
                    if(result === 'win_invader') p = progress * 100;
                    else {
                        if(progress < 0.5) p = progress * 2 * 60; 
                        else p = 60 - (progress - 0.5) * 2 * 60;
                    }
                } 
                else if (scenario === 'war') {
                    let base = progress * 100;
                    if(result === 'win_defender') base = (-4 * Math.pow(progress, 2) + 4 * progress) * 85; 
                    p = base + Math.sin(progress * 40) * 5; 
                }
                else if (scenario === 'liberation') {
                    if (result === 'win_defender') {
                        p = 100 - (progress * 100);
                    } else {
                        if (progress < 0.4) p = 100 - (progress * 2.5 * 50); 
                        else {
                            let sp = (progress - 0.4) / 0.6;
                            p = 50 + (sp * 50);
                        }
                    }
                }
                else if (scenario === 'heavy_lib') {
                    if (result === 'win_defender') {
                        let base = 100 - (progress * 100);
                        p = base + Math.sin(progress * 50) * 8; 
                    } else {
                        let base = 100;
                        if (progress < 0.5) base = 100 - (Math.sin(progress * Math.PI) * 40);
                        else base = 60 + ((progress-0.5)*2 * 40);
                        p = base + Math.cos(progress * 60) * 5;
                    }
                }
                setInvasionPercent(p);
                requestAnimationFrame(simLoop);
            }
            simLoop();
        }

        function finishSim(finalVal) {
            isSimulating = false;
            setInvasionPercent(finalVal);
            recorder.stop();
            document.getElementById('rec-status').innerText = LANG[currentLang].status_proc;
            if(deviceMode === 'mobile') toggleMobileMenu();
        }

        function saveVideo() {
            const blob = new Blob(chunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Sim_${Date.now()}.webm`;
            a.innerHTML = LANG[currentLang].dl_btn;
            const area = document.getElementById('download-area');
            area.style.display = 'block';
            area.innerHTML = '';
            area.appendChild(a);
            document.getElementById('rec-status').style.display = 'none';
        }

        function animate() {
            requestAnimationFrame(animate);
            if(globe) globe.rotation.y += 0.002;
            if(stars) stars.rotation.y -= 0.0005;
            controls.update();
            renderer.render(scene, camera);
        }

        init();
    </script>
</body>
</html>
